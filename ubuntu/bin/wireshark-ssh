#!/bin/bash -l
# -*- mode: shell-script; -*-
set -e

function usage {
  echo "$0 [-s] [-p=password] [-i=interface] [-p=port] [-l=name] user@host"
  exit 1
}

sudo_password=""
sudo=""
ssh_port=22
lxc_name=""
ifaces=()

while getopts ":s:i:h:l:p" opt; do
  case $opt in
    p)
      sudo_password="$OPTARG"
      ;;
    s)
      sudo="yes"
      ;;
    i)
      ifaces[${#ifaces[@]}]="$OPTARG"
      ;;
    p)
      ssh_port="$OPTARG"
      ;;
    l)
      lxc_name="$OPTARG"
      ;;
    h)
      usage
      ;;
    \?)
      echo "Invalid option: -$OPTARG" >&2
      ;;
  esac
done

shift $((OPTIND-1))
if [ -z "$1" ] ; then
  usage
  exit 1
fi

cmd=""
if [ ! -z "$sudo" ] ; then
    if [ ! -z "$sudo_password" ] ; then
        cmd="$cmd echo $sudo_password | sudo -S"
    else
        cmd="$cmd sudo"
    fi
fi

if [ ! -z "$lxc_name" ] ; then
  cmd="$cmd lxc-attach -n $lxc_name --"
fi

cmd="$cmd tcpdump -U -s0"
for iface in "${ifaces[@]}"; do
  cmd="$cmd -i $iface"
done

cmd="$cmd -w - 'not port $ssh_port'"
echo $cmd
ssh -p $ssh_port $1 "$cmd" | wireshark -k -i -
